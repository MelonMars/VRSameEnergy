<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>VR Inspiration Browser</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

            body {
                margin: 0;
                padding: 0;
                background: radial-gradient(ellipse at center, #1a1a2e 0%, #0f0f1a 100%);
                font-family: 'Inter', sans-serif;
                overflow: hidden;
                font-weight: 400;
            }
            #ui {
                position: absolute;
                top: 20px;
                left: 20px;
                color: white;
                z-index: 100;
                font-size: 14px;
                background: rgba(10, 10, 20, 0.85);
                padding: 24px;
                border-radius: 16px;
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.08);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                min-width: 280px;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            #ui:hover {
                background: rgba(15, 15, 25, 0.9);
                border-color: rgba(255, 255, 255, 0.12);
                transform: translateY(-1px);
            }
            #vrButton {
                position: absolute;
                bottom: 30px;
                left: 30px;
                padding: 16px 32px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
                color: white;
                border: none;
                border-radius: 50px;
                cursor: pointer;
                font-size: 15px;
                font-weight: 600;
                z-index: 100;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
                letter-spacing: 0.5px;
            }
            #vrButton:hover {
                transform: translateY(-3px) scale(1.05);
                box-shadow: 0 12px 40px rgba(102, 126, 234, 0.5);
                background: linear-gradient(135deg, #7c8df8 0%, #8a5cc2 50%, #f5a5ff 100%);
            }            
            #vrButton:disabled {
                background: #666;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }
            #instructions {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: white;
                text-align: center;
                background: rgba(10, 10, 20, 0.9);
                padding: 40px;
                border-radius: 24px;
                z-index: 100;
                max-width: 500px;
                backdrop-filter: blur(25px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 16px 64px rgba(0, 0, 0, 0.4);
            }            
            #instructions h2 {
                background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                font-size: 2.8em;
                margin-bottom: 24px;
                font-weight: 700;
            }            
            #selectedImages {
                position: absolute;
                top: 20px;
                right: 20px;
                color: white;
                z-index: 100;
                background: rgba(10, 10, 20, 0.85);
                padding: 24px;
                border-radius: 16px;
                max-width: 280px;
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.08);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            #selectedImages:hover {
                background: rgba(15, 15, 25, 0.9);
                border-color: rgba(255, 255, 255, 0.12);
                transform: translateY(-1px);
            }                        
            .selected-image {
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
                padding: 12px;
                margin: 12px 0;
                border-radius: 12px;
                font-size: 13px;
                display: flex;
                align-items: center;
                gap: 12px;
                border: 1px solid rgba(255, 255, 255, 0.06);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .selected-image:hover {
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.08));
                border-color: rgba(255, 255, 255, 0.15);
                transform: translateX(4px);
            }            
            .selected-image img {
                width: 36px;
                height: 36px;
                border-radius: 8px;
                object-fit: cover;
                border: 1px solid rgba(255, 255, 255, 0.1);
            }            
            #controls {
                position: absolute;
                bottom: 30px;
                right: 30px;
                color: white;
                z-index: 100;
                background: rgba(10, 10, 20, 0.85);
                padding: 20px;
                border-radius: 16px;
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.08);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            }            
            .control-group select, .control-group input {
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.12);
                color: white;
                padding: 8px 12px;
                border-radius: 8px;
                font-size: 13px;
                transition: all 0.2s ease;
                font-family: 'Inter', sans-serif;
            }
            .control-group select:focus, .control-group input:focus {
                outline: none;
                border-color: rgba(102, 126, 234, 0.5);
                box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
            }            
            .control-group label {
                min-width: 80px;
                font-size: 14px;
            }
            .control-group select option {
                background: #333;
                color: white;
            }
            button {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border: none;
                border-radius: 8px;
                padding: 10px 20px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 500;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                font-family: 'Inter', sans-serif;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            }
            button:hover {
                transform: translateY(-1px);
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
                background: linear-gradient(135deg, #7c8df8, #8a5cc2);
            }
            #cursor {
                position: fixed;
                top: 0;
                left: 0;
                width: 8px;
                height: 8px;
                background: linear-gradient(135deg, #667eea, #764ba2);
                border-radius: 50%;
                pointer-events: none;
                transform: translate(-50%, -50%);
                z-index: 9999;
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
            }
            #cursor.hover {
                width: 32px;
                height: 32px;
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.6), rgba(118, 75, 162, 0.6));
                box-shadow: 0 0 30px rgba(102, 126, 234, 1);
            }
            #gridContainer {
                display: none;
                position: absolute;
                top: 0;
                left: 350px; 
                width: calc(100% - 700px);
                height: 100%;
                overflow-y: auto;
                padding: 100px 20px 40px 20px;
                box-sizing: border-box;
                z-index: 50;
            }
            #imageGrid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 20px;
            }
            .grid-item {
                position: relative;
                cursor: pointer;
                border-radius: 12px;
                overflow: hidden;
                transition: all 0.3s ease;
            }
            .grid-item:hover {
                transform: scale(1.03);
                border: 2px solid #764ba2;
            }
            .grid-item img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }
            .grid-item .overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                color: white;
                display: flex;
                justify-content: center;
                align-items: center;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            .grid-item:hover .overlay {
                opacity: 1;
            }
            #speedSlider::-moz-range-thumb {
                width: 18px;
                height: 18px;
                background: #4a90e2;
                border-radius: 50%;
                cursor: pointer;
                border: none;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            #speedSlider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 18px;
                height: 18px;
                background: #4a90e2;
                border-radius: 50%;
                cursor: pointer;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            #gapSlider::-moz-range-thumb {
                width: 18px;
                height: 18px;
                background: #4a90e2;
                border-radius: 50%;
                cursor: pointer;
                border: none;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            #gapSlider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 18px;
                height: 18px;
                background: #4a90e2;
                border-radius: 50%;
                cursor: pointer;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            #borderRadiusSlider::-moz-range-thumb {
                width: 18px;
                height: 18px;
                background: #4a90e2;
                border-radius: 50%;
                cursor: pointer;
                border: none;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            #borderRadiusSlider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 18px;
                height: 18px;
                background: #4a90e2;
                border-radius: 50%;
                cursor: pointer;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }

        </style>
    </head>
    <body>
        <div id="cursor"></div>
        <div id="ui">
            <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <label for="toggle2D" style="font-weight: bold;">2D Mode:</label>
                <input type="checkbox" id="toggle2D" style="width: 20px; height: 20px; cursor: pointer;" class="hover-target">
            </div>
            <div style="margin-bottom: 15px;">
                <strong>Images Seen:</strong> <span id="imageCount">0</span>
            </div>
            <div style="margin-bottom: 15px;">
                <strong>Liked:</strong> <span id="selectedCount">0</span>
            </div>
            <div style="margin-bottom: 15px;">
                <strong>Speed:</strong> <span id="speedDisplay">1.0x</span>
            </div>
            <div style="margin-bottom: 15px;">
                <strong>Search Term:</strong> <span id="currentTheme">Mixed</span>
            </div>
            
            <div style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
                <div style="margin-bottom: 10px;">
                    <label style="font-weight: bold; margin-bottom: 5px; display: block;">Search Mode:</label>
                    <select id="searchMode" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;">
                        <option value="text">Text Search</option>
                        <option value="image">Image Search</option>
                        <option value="blend">Blend Search</option>
                        <option value="multi">Multi-Theme Search</option>
                    </select>
                </div>
                
                <div id="textSearchSection">
                    <div class="control-group" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <button id="historyButton" style="background: none; border: none; cursor: pointer; padding: 0;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                <path d="M3 3v5h5"/>
                                <path d="M12 7v5l4 2"/>
                            </svg>
                        </button> 
                        <input type="text" id="searchBar" placeholder="Type to search..." style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;">
                        <button id="searchButton" type="submit" style="padding: 8px 16px; border-radius: 6px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; font-size: 14px; font-weight: bold; cursor: pointer;">Search</button>
                    </div>
                </div>
                
                <div id="imageSearchSection" style="display: none;">
                    <div style="margin-bottom: 10px;">
                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">Upload Image:</label>
                        <label for="imageUpload" style="display: block; padding: 10px; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.2); background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-size: 14px; text-align: center; cursor: pointer; transition: all 0.3s ease;">
                            Upload Image
                            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                        </label>
                    </div>
                    <button id="imageSearchButton" style="width: 100%; padding: 10px; border-radius: 6px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; font-size: 14px; font-weight: bold; cursor: pointer;">Search by Image</button>
                </div>
                
                <div id="blendSearchSection" style="display: none;">
                    <div style="margin-bottom: 10px;">
                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">Text (optional):</label>
                        <input type="text" id="blendTextInput" placeholder="Describe what you want..." style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">Images (optional):</label>
                        <label for="blendImageUpload" style="display: block; padding: 10px; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.2); background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-size: 14px; text-align: center; cursor: pointer; transition: all 0.3s ease;">
                            Upload Images
                            <input type="file" id="blendImageUpload" accept="image/*" multiple style="display: none;">
                        </label>
                    </div>
                    <div id="blendPreview" style="margin-bottom: 10px; display: flex; gap: 5px; flex-wrap: wrap;"></div>
                    <button id="blendSearchButton" style="width: 100%; padding: 10px; border-radius: 6px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; font-size: 14px; font-weight: bold; cursor: pointer;">Search Blend</button>
                </div>

                <div id="multiSearchSection" style="display: none;">
                    <div style="margin-bottom: 10px;">
                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">Search Terms:</label>
                        <div id="multiSearchInputs">
                            <div class="multi-search-input" style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <input type="text" placeholder="Enter search term..." style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;">
                                <button type="button" class="remove-term" style="padding: 8px; background: #ff4d4d; color: white; border: none; border-radius: 6px; cursor: pointer;">×</button>
                            </div>
                        </div>
                        <button id="addTermButton" style="width: 100%; padding: 8px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; cursor: pointer;">+ Add Another Term</button>
                    </div>
                    <button id="multiSearchButton" style="width: 100%; padding: 10px; border-radius: 6px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; font-size: 14px; font-weight: bold; cursor: pointer;">Search All Themes</button>
                </div>
                <button id="settingsButton" style="background: none; border: none; cursor: pointer; padding: 0;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings-icon lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
            </div>
        </div>
        <div id="gridContainer">
            <div id="imageGrid"></div>
            <div id="sentinel" style="height: 50px;"></div>
        </div>
        <div id="selectedImages">
            <h3>Inspiration Board</h3>
            <button id="sendToCanvasButton" style="width: 100%; padding: 10px; border-radius: 6px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 10px;">Send to Canvas</button>
            <div id="selectedList"></div>
        </div>
        
        <button id="vrButton">Enter VR</button>
        
        <div id="instructions">
            <h2>🎨 Inspiration Browser</h2>
            <p>Dive into an endless stream of visual inspiration!</p>
            <p>🖱️ <strong>Click</strong> on images that spark your creativity</p>
            <p>🥽 <strong>VR Mode:</strong> Point and trigger to collect inspiration</p>
            <p>Choose different themes to explore various aesthetic vibes</p>
            <p><em>Search for what you're looking for to begin!</em></p>
            <div class="control-group">
                <form id="searchForm">
                    <label for="searchInput">Search:</label>
                    <input type="text" id="searchInput" placeholder="Type to search...">
                    <button type="submit">Submit</button>
                </form>
            </div>
        </div>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
        <script>
            const cursor = document.getElementById('cursor');
            let cursorX = window.innerWidth / 2;
            let cursorY = window.innerHeight / 2;
            let targetX = cursorX;
            let targetY = cursorY;
            const speed = 0.1;

            window.addEventListener('mousemove', e => {
                targetX = e.clientX;
                targetY = e.clientY;
            });

            function animateCursor() {
                cursorX += (targetX - cursorX) * speed;
                cursorY += (targetY - cursorY) * speed;

                cursor.style.top = `${cursorY}px`;
                cursor.style.left = `${cursorX}px`;

                requestAnimationFrame(animateCursor);
            }

            animateCursor();

            function updateHoverTargets() {
                const hoverTargets = document.querySelectorAll('a, button, input, select, .hover-target, .selected-image');
                hoverTargets.forEach(el => {
                    el.addEventListener('mouseenter', () => cursor.classList.add('hover'));
                    el.addEventListener('mouseleave', () => cursor.classList.remove('hover'));
                });
            }            

            updateHoverTargets();

            class VRInspirationBrowser {
                constructor() {
                    this.scene = null;
                    this.camera = null;
                    this.renderer = null;
                    this.images = [];
                    this.selectedImages = [];
                    this.imagesSeen = 0;
                    this.gameStarted = false;
                    this.isVR = false;
                    this.controllers = [];
                    this.raycaster = new THREE.Raycaster();
                    this.mouse = new THREE.Vector2();
                    this.speed = 1.0;
                    this.spawnDelay = 800;
                    this.backendImages = [];
                    this.imageIndex = 0;
                    this.currentTheme = 'Search';
                    this.imageCache = new Map();
                    this.searchCache = new Map();
                    this.historyModalOpen = false;
                    this.settingsModalOpen = false;
                    this.twodmode = false;
                    this.gridContainer = document.getElementById('gridContainer');
                    this.imageGrid = document.getElementById('imageGrid');
                    this.scrollAccumulator = 0;
                    this.scrollSpawnThreshold = 100;
                    this.currentPage = 1;
                    this.isLoading = false;
                    this.allResultsLoaded = false;
                    this.lastSearch = { type: null, query: null };
                    this.searchAbortController = null;
                    this.observer = null;
                    this.keybinds = {
                        toggle2D: 't',
                        sendToCanvas: 'c',
                        openHistory: 'h',
                        openSettings: 's',
                        increaseSpeed: 'ArrowUp',
                        decreaseSpeed: 'ArrowDown'
                    }
                    this.keybindsName = {
                        toggle2D: 'Toggle 2D Mode',
                        sendToCanvas: 'Send to Canvas',
                        openHistory: 'Open History',
                        openSettings: 'Open Settings',
                        increaseSpeed: 'Increase Speed',
                        decreaseSpeed: 'Decrease Speed'
                    }
                    this.backend = 'http://127.0.0.1:8000'

                    this.init();
                    this.setupEventListeners();
                    this.animate();
                }
    
                init() {
                    const savedBoard = localStorage.getItem('vrInspirationBoard');
                    console.log("Selected images: ", savedBoard);
                    if (savedBoard) {
                        const board = JSON.parse(savedBoard);
                    
                        this.selectedImages = board.map(imgData => ({
                            id: imgData.id,
                            imageUrl: imgData.imageUrl,
                            description: imgData.description || '',
                            name: imgData.name || '', 
                            timestamp: imgData.timestamp || new Date().toISOString()
                        }));
                    
                        console.log(`Loaded ${this.selectedImages.length} images from inspiration board.`, this.selectedImages);
                        this.updateSelectedImagesUI();
                    }                    

                    this.scene = new THREE.Scene();
                    this.scene.background = new THREE.Color(0x0a0a0a);
    
                    this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                    this.camera.position.set(0, 0, 0);
    
                    this.renderer = new THREE.WebGLRenderer({ antialias: true });
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                    this.renderer.setPixelRatio(window.devicePixelRatio);
                    this.renderer.xr.enabled = true;
                    document.body.appendChild(this.renderer.domElement);
    
                    const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                    this.scene.add(ambientLight);
    
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(5, 10, 5);
                    this.scene.add(directionalLight);
                    this.setupIntersectionObserver();
                    this.setupVR();
                }
        
                setupIntersectionObserver() {
                    const options = {
                        root: this.gridContainer,
                        rootMargin: '0px',
                        threshold: 0.5
                    };
                
                    this.observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting && !this.isLoading && !this.allResultsLoaded) {
                                console.log('Sentinel is visible. Fetching paginated images...');
                                this.fetchPaginatedImages();
                            }
                        });
                    }, options);
                
                    const sentinel = document.getElementById('sentinel');
                    if (sentinel) {
                        this.observer.observe(sentinel);
                    } else {
                        console.error('Sentinel element not found. Ensure it exists in the DOM.');
                    }
                }

                setupVR() {
                    const vrButton = document.getElementById('vrButton');
                    
                    if ('xr' in navigator) {
                        navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
                            if (supported) {
                                vrButton.addEventListener('click', () => this.enterVR());
                            } else {
                                vrButton.textContent = 'VR Not Supported';
                                vrButton.disabled = true;
                            }
                        });
                    } else {
                        vrButton.textContent = 'WebXR Not Available';
                        vrButton.disabled = true;
                    }
    
                    const controller1 = this.renderer.xr.getController(0);
                    controller1.addEventListener('selectstart', (e) => this.onControllerSelect(e, 0));
                    this.scene.add(controller1);
    
                    const controller2 = this.renderer.xr.getController(1);
                    controller2.addEventListener('selectstart', (e) => this.onControllerSelect(e, 1));
                    this.scene.add(controller2);
    
                    this.controllers = [controller1, controller2];
    
                    const controllerGeometry = new THREE.CylinderGeometry(0.01, 0.02, 0.08, 6);
                    const controllerMaterial = new THREE.MeshBasicMaterial({ color: 0x667eea });
                    
                    const controllerMesh1 = new THREE.Mesh(controllerGeometry, controllerMaterial);
                    const controllerMesh2 = new THREE.Mesh(controllerGeometry, controllerMaterial);
                    
                    controller1.add(controllerMesh1);
                    controller2.add(controllerMesh2);
                }
    
                async enterVR() {
                    try {
                        const session = await navigator.xr.requestSession('immersive-vr');
                        this.renderer.xr.setSession(session);
                        this.isVR = true;
                        document.getElementById('vrButton').style.display = 'none';
                    } catch (error) {
                        console.error('Failed to enter VR:', error);
                    }
                }
    
                setupEventListeners() {
                    document.getElementById('settingsButton').addEventListener('click', () => {
                        this.settingsModalOpen = !this.settingsModalOpen;
                        this.openSettings();
                    });

                    document.getElementById('toggle2D').addEventListener('change', (e) => {
                        this.twodmode = e.target.checked;
                        this.updateDisplayMode();
                    });

                    document.getElementById('sendToCanvasButton').addEventListener('click', () => {
                        if (this.selectedImages.length > 0) {
                            const imageUrls = this.selectedImages.map(imgData => imgData.imageUrl);
                            sessionStorage.setItem('initialCanvasImages', JSON.stringify(imageUrls));
                            window.open('canvas.html', 'vrCanvas');
                        } else {
                            alert('Please select at least one image to send to the canvas.');
                        }
                    });

                    document.addEventListener('click', (e) => {
                        this.onMouseClick(e);
                    });
                    
                    window.addEventListener('wheel', (e) => this.onMouseWheel(e)); 

                    document.addEventListener('mousemove', (e) => this.onMouseMove(e));
                    window.addEventListener('resize', () => this.onWindowResize());

                    document.addEventListener('keydown', (e) => {
                        if (e.key === this.keybinds.increaseSpeed) {
                            this.speed = Math.min(this.speed + 0.1, 3.0);
                        } else if (e.key === this.keybinds.decreaseSpeed) {
                            this.speed = Math.max(this.speed - 0.1, 0.3);
                        }
                    });

                    document.getElementById('historyButton').addEventListener('click', () => {
                        this.openHistory();
                    });

                    document.addEventListener('keydown', (e) => {
                        console.log("Key pressed:", e.key);
                        console.log("Keybinds: ", this.keybinds);
                        if (e.key === this.keybinds.toggle2D) {
                            document.getElementById('toggle2D').checked = !document.getElementById('toggle2D').checked;
                            this.twodmode = document.getElementById('toggle2D').checked;
                            this.updateDisplayMode();
                        } else if (e.key === this.keybinds.sendToCanvas) {
                            document.getElementById('sendToCanvasButton').click();
                        } else if (e.key === this.keybinds.openHistory) {
                            document.getElementById('historyButton').click();
                        } else if (e.key === this.keybinds.openSettings) {
                            document.getElementById('settingsButton').click();
                        }
                    });

                    document.getElementById('searchMode').addEventListener('change', (e) => {
                        const mode = e.target.value;
                        document.getElementById('textSearchSection').style.display = mode === 'text' ? 'block' : 'none';
                        document.getElementById('imageSearchSection').style.display = mode === 'image' ? 'block' : 'none';
                        document.getElementById('blendSearchSection').style.display = mode === 'blend' ? 'block' : 'none';
                        document.getElementById('multiSearchSection').style.display = mode === 'multi' ? 'block' : 'none';
                    });

                    document.getElementById('addTermButton').addEventListener('click', () => {
                        const container = document.getElementById('multiSearchInputs');
                        const newInput = document.createElement('div');
                        newInput.className = 'multi-search-input';
                        newInput.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
                        newInput.innerHTML = `
                            <input type="text" placeholder="Enter search term..." style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;">
                            <button type="button" class="remove-term" style="padding: 8px; background: #ff4d4d; color: white; border: none; border-radius: 6px; cursor: pointer;">×</button>
                        `;
                        container.appendChild(newInput);
                        updateHoverTargets();
                    });
                    
                    document.getElementById('multiSearchInputs').addEventListener('click', (e) => {
                        if (e.target.classList.contains('remove-term')) {
                            const inputs = document.querySelectorAll('.multi-search-input');
                            if (inputs.length > 1) {
                                e.target.closest('.multi-search-input').remove();
                            }
                        }
                    });

                    document.getElementById('multiSearchButton').addEventListener('click', async () => {
                        const inputs = document.querySelectorAll('#multiSearchInputs input');
                        const terms = Array.from(inputs)
                            .map(input => input.value.trim())
                            .filter(term => term.length > 0);
                        
                        if (terms.length === 0) return;
                        
                        try {
                            this.backendImages = [];
                            this.imageIndex = 0;
                            
                            await this.searchText(terms[0]);
                            
                            for (let i = 1; i < terms.length; i++) {
                                await this.searchTextAndAdd(terms[i]);
                            }
                            
                            this.currentTheme = terms.join(' + ');
                            document.getElementById('currentTheme').textContent = this.currentTheme;
                            
                            this.startGame();
                        } catch (error) {
                            console.error('Error during multi-theme search:', error);
                        }
                    });                    
                
                    document.getElementById('searchButton').addEventListener('click', () => {
                        const searchValue = document.getElementById('searchBar').value.trim();
                        if (searchValue) {
                            this.searchText(searchValue).then(() => {
                                this.startGame();
                            }).catch(error => {
                                console.error('Error during search:', error);
                            });
                        }
                    });
                
                    document.getElementById('imageSearchButton').addEventListener('click', () => {
                        const fileInput = document.getElementById('imageUpload');
                        if (fileInput.files.length > 0) {
                            const file = fileInput.files[0];
                            this.searchImage(file).then(() => {
                                this.startGame();
                            }).catch(error => {
                                console.error('Error during image search:', error);
                            });
                        }
                    });
                
                    document.getElementById('blendSearchButton').addEventListener('click', () => {
                        const text = document.getElementById('blendTextInput').value.trim();
                        const fileInput = document.getElementById('blendImageUpload');
                        const files = Array.from(fileInput.files);
                        
                        if (text || files.length > 0) {
                            this.searchBlend(text, files).then(() => {
                                this.startGame();
                            }).catch(error => {
                                console.error('Error during blend search:', error);
                            });
                        }
                    });
                
                    document.getElementById('blendImageUpload').addEventListener('change', (e) => {
                        const preview = document.getElementById('blendPreview');
                        preview.innerHTML = '';
                        
                        Array.from(e.target.files).forEach((file, index) => {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const img = document.createElement('img');
                                img.src = e.target.result;
                                img.style.width = '40px';
                                img.style.height = '40px';
                                img.style.objectFit = 'cover';
                                img.style.borderRadius = '4px';
                                img.style.border = '1px solid rgba(255,255,255,0.2)';
                                preview.appendChild(img);
                            };
                            reader.readAsDataURL(file);
                        });
                    });
                
                    document.getElementById('searchBar').addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            document.getElementById('searchButton').click();
                        }
                    });
                
                    document.getElementById('blendTextInput').addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            document.getElementById('blendSearchButton').click();
                        }
                    });

                    this.gridContainer.addEventListener('scroll', () => {
                        if (this.twodmode && !this.isLoading && !this.allResultsLoaded) {
                            const { scrollTop, scrollHeight, clientHeight } = this.gridContainer;
                            
                            if (scrollTop + clientHeight >= scrollHeight - 500) {
                                this.fetchPaginatedImages();
                            }
                        }
                    });
                }
    
                async searchImage(image) {
                    const formData = new FormData();
                    formData.append("file", image);

                    const response = await fetch(`${this.backend}/search_image/?top_k=2`, {
                        method: "POST",
                        body: formData,
                        headers: {
                            'ngrok-skip-browser-warning': 'true'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data && Array.isArray(data.images) && data.images.length > 0) {
                        this.backendImages = data.images.map(img => `${this.backend}${img}`);
                        console.log(`Fetched and cached ${this.backendImages.length} images from image search`);
                    } else {
                        console.error('No images found or invalid format from backend.');
                        this.backendImages = [];
                        return;
                    }

                    this.currentTheme = 'Image Search';
                    document.getElementById('currentTheme').textContent = 'Image Search';
                }

                async fetchPaginatedImages() {    
                    console.log(`Starting fetchPaginatedImages for page ${this.currentPage + 1}...`);
                    this.isLoading = true;
                    let url;
                    const topK = 2;
    
                    console.log(`Preparing to fetch images for search type: ${this.lastSearch.type} and query: ${this.lastSearch.query}`);
                    switch (this.lastSearch.type) {
                        case 'text':
                            console.log(`Fetching text search results for query: "${this.lastSearch.query}"`);
                            url = `${this.backend}/search_text/?text=${encodeURIComponent(this.lastSearch.query)}&top_k=${topK}&page=${this.currentPage}`;
                            break;
                        case 'multi':
                            console.log(`Fetching multi-text search results for queries: ${this.lastSearch.query.join(', ')}`);
                            const termsQuery = this.lastSearch.query.map(t => `texts=${encodeURIComponent(t)}`).join('&');
                            url = `${this.backend}/search_multi_text/?${termsQuery}&top_k=${topK}&page=${this.currentPage}`;
                            break;
                        default:
                            console.warn('Unknown search type. Aborting fetchPaginatedImages.');
                            this.isLoading = false;
                            return;
                    }
    
                    console.log(`Constructed URL: ${url}`);
    
                    try {
                        if (!this.searchAbortController) {
                            this.searchAbortController = new AbortController();
                        }
                        const response = await fetch(url, { signal: this.searchAbortController.signal }, {
                            headers: {
                                'ngrok-skip-browser-warning': 'true'
                            }
                        });
                        console.log(`Received response with status: ${response.status}`);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log('Response data:', data);
    
                        if (data && Array.isArray(data.images) && data.images.length > 0) {
                            console.log(`Fetched ${data.images.length} new images.`);
                            const newImageUrls = data.images.map(img => `${this.backend}${img}`);
                            this.backendImages.push(...newImageUrls);
                            this.backendImages = [...new Set(this.backendImages)]; 
                            console.log(`Total images in backendImages: ${this.backendImages.length}`);
                            this.appendImagesToGrid(newImageUrls);
                            this.currentPage++;
                            console.log(`Incremented currentPage to ${this.currentPage}`);
                        } else {
                            console.log('No more images found. Marking allResultsLoaded as true.');
                            this.allResultsLoaded = true;
                            this.displayEndOfResultsMessage();
                        }
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            console.warn('Fetch aborted by user.');
                        } else {
                            console.error('Error fetching paginated images:', error);
                        }
                    } finally {
                        this.isLoading = false;
                        console.log('fetchPaginatedImages completed.');
                    }
                }
                
                async performNewSearch(searchType, query) {
                    console.log(`Performing new search of type "${searchType}" with query: "${query}"`);
                    if (this.searchAbortController) {
                        this.searchAbortController.abort();
                    }
                    this.searchAbortController = new AbortController();
    
                    this.isLoading = false;
                    this.allResultsLoaded = false;
                    this.currentPage = 1;
                    this.backendImages = [];
                    this.lastSearch = { type: searchType, query: query };
    
                    if (this.twodmode) {
                        this.imageGrid.innerHTML = '';
                    } else {
                        this.clearScene();
                    }
    
                    const endMessage = this.gridContainer.querySelector('.end-of-results');
                    if (endMessage) endMessage.remove();
    
                    await this.fetchPaginatedImages();
                    this.startGame();
                }
    
                async searchText(searchTerm) {
                    this.currentTheme = searchTerm;
                    document.getElementById('currentTheme').textContent = searchTerm;
                    await this.performNewSearch('text', searchTerm);
                }
    
                async searchMultipleTerms(terms) {
                    const themeName = terms.join(' + ');
                    this.currentTheme = themeName;
                    document.getElementById('currentTheme').textContent = themeName;
                    await this.performNewSearch('multi', terms);
                }
    
                /*document.getElementById('multiSearchButton').addEventListener('click', async () => {
                    const inputs = document.querySelectorAll('#multiSearchInputs input');
                    const terms = Array.from(inputs)
                        .map(input => input.value.trim())
                        .filter(term => term.length > 0);
                    
                    if (terms.length > 0) {
                        this.searchMultipleTerms(terms).catch(error => {
                             console.error('Error during multi-theme search:', error);
                        });
                    }
                });*/

                async searchBlend(text = '', files = []) {
                    const formData = new FormData();
                    
                    if (text) {
                        formData.append("text", text);
                    }
                    
                    files.forEach(file => {
                        formData.append("files", file);
                    });
                
                    const response = await fetch(`${this.backend}/search_blend/?top_k=2`, {
                        method: "POST",
                        body: formData,
                        headers: {
                            'ngrok-skip-browser-warning': 'true'
                        }
                    });
                
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                
                    const data = await response.json();
                
                    if (data && Array.isArray(data.images) && data.images.length > 0) {
                        this.backendImages = data.images.map(img => `${this.backend}${img}`);
                        console.log(`Fetched ${this.backendImages.length} images from blend search`);
                    } else {
                        console.error('No images found or invalid format from backend.');
                        this.backendImages = [];
                        return;
                    }
                
                    let themeDesc = 'Blend Search';
                    if (text && files.length > 0) {
                        themeDesc = `"${text}" + ${files.length} images`;
                    } else if (text) {
                        themeDesc = `"${text}"`;
                    } else if (files.length > 0) {
                        themeDesc = `${files.length} images`;
                    }
                    
                    this.currentTheme = themeDesc;
                    document.getElementById('currentTheme').textContent = this.currentTheme;
                } 
                
                async searchText(searchTerm) {
                    if (this.searchCache.has(searchTerm)) {
                        this.backendImages = this.searchCache.get(searchTerm);
                        console.log(`Using cached results for "${searchTerm}"`);
                    } else {
                        const response = await fetch(`${this.backend}/search_text/?text=${encodeURIComponent(searchTerm)}&top_k=2`, {
                            headers: {
                                'ngrok-skip-browser-warning': 'true'
                            }
                        });
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        
                        if (data && Array.isArray(data.images) && data.images.length > 0) {
                            this.backendImages = data.images.map(img => `${this.backend}${img}`);
                            this.searchCache.set(searchTerm, this.backendImages);
                            console.log(`Fetched and cached ${this.backendImages.length} images for "${searchTerm}"`);
                        } else {
                            console.error('No images found or invalid format from backend.');
                            this.backendImages = [];  
                            return;
                        }
                    }
                    this.currentTheme = searchTerm;
                    document.getElementById('currentTheme').textContent = searchTerm;
                }

                async searchTextAndAdd(searchTerm) {
                    if (this.searchCache.has(searchTerm)) {
                        const cachedImages = this.searchCache.get(searchTerm);
                        this.backendImages.push(...cachedImages);
                    } else {
                        const response = await fetch(`${this.backend}/search_text/?text=${encodeURIComponent(searchTerm)}&top_k=2`, {
                            headers: {
                                'ngrok-skip-browser-warning': 'true'
                            }
                        });
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();

                        if (data && Array.isArray(data.images) && data.images.length > 0) {
                            this.backendImages.push(...data.images.map(img => `${this.backend}${img}`));
                            this.searchCache.set(searchTerm, this.backendImages);
                            console.log(`Fetched and cached ${data.images.length} images for "${searchTerm}"`);
                        } else {
                            console.error('No images found or invalid format from backend.');
                            this.backendImages = [];
                            return;
                        }
                    }
                    this.currentTheme = searchTerm;
                    document.getElementById('currentTheme').textContent = searchTerm;
                    this.imageIndex = 0;
                }

                async startGame() {
                    this.gameStarted = true;
                    document.getElementById('instructions').style.display = 'none';

                    if (this.twodmode) {
                        this.displayImagesAsGrid();
                    } else {
                        this.imageIndex = 0;
                        this.clearScene();
                        this.spawnImages(); 
                    }
                }
                updateDisplayMode() {
                    const vrButton = document.getElementById('vrButton');
                    if (this.twodmode) {
                        vrButton.style.display = 'none';
                        this.renderer.domElement.style.display = 'none';
                        this.gridContainer.style.display = 'block';
                        document.body.style.overflow = 'hidden'; 
                        if (this.gameStarted) {
                            this.clearScene(); 
                            this.displayImagesAsGrid();
                        }
                    } else {
                        vrButton.style.display = 'block';
                        this.renderer.domElement.style.display = 'block';
                        this.gridContainer.style.display = 'none';
                        document.body.style.overflow = 'hidden';
                        if (this.gameStarted) {
                            this.imageGrid.innerHTML = '';
                            this.clearScene();
                            this.imageIndex = 0;
                            this.spawnImages();
                        }
                    }
                }

                displayImagesAsGrid() {
                    this.imageGrid.innerHTML = ''; 
                    this.imagesSeen = 0;
                    if (this.backendImages.length === 0) return;

                    this.backendImages.forEach((imageUrl, index) => {
                        const imageData = {
                            id: `backend_grid_${Date.now()}_${index}`,
                            theme: this.currentTheme,
                            name: `${this.currentTheme} #${index + 1}`,
                            imageUrl: imageUrl
                        };

                        const item = document.createElement('div');
                        item.className = 'grid-item hover-target';
                        item.dataset.imageData = JSON.stringify(imageData);
                        
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = imageData.name;
                        img.onload = () => {
                            item.style.opacity = 1; 
                        };
                        item.style.opacity = 0;
                        item.style.transition = 'opacity 0.5s ease';

                        const overlay = document.createElement('div');
                        overlay.className = 'overlay';
                        overlay.textContent = 'Click to Select';
                        
                        item.appendChild(img);
                        item.appendChild(overlay);

                        item.addEventListener('click', () => {
                            this.selectImage(null, item);
                            item.classList.add('selected');
                        });

                        this.imageGrid.appendChild(item);
                        this.imagesSeen++;
                    });
                    this.updateUI();
                    updateHoverTargets();
                }
    
                appendImagesToGrid(imageUrls) {
                    imageUrls.forEach((imageUrl, index) => {
                        const imageData = {
                            id: `backend_grid_${Date.now()}_${this.imageIndex + index}`,
                            theme: this.currentTheme,
                            name: `${this.currentTheme} #${this.imageIndex + index + 1}`,
                            imageUrl: imageUrl
                        };

                        const item = document.createElement('div');
                        item.className = 'grid-item hover-target';
                        item.dataset.imageData = JSON.stringify(imageData);
                        
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = imageData.name;
                        img.onload = () => {
                            item.style.opacity = 1; 
                        };
                        item.style.opacity = 0;
                        item.style.transition = 'opacity 0.5s ease';

                        const overlay = document.createElement('div');
                        overlay.className = 'overlay';
                        overlay.textContent = 'Click to Select';
                        
                        item.appendChild(img);
                        item.appendChild(overlay);

                        item.addEventListener('click', () => {
                            this.selectImage(null, item);
                            item.classList.add('selected');
                        });

                        this.imageGrid.appendChild(item);
                    });
                    this.imageIndex += imageUrls.length;
                    this.updateUI();
                }
    
                displayEndOfResultsMessage() {
                    console.log("Displaying end of results message");
                    const messageElement = document.createElement('div');
                    messageElement.className = 'end-of-results';
                    messageElement.textContent = "You've reached the end!";
                    messageElement.style.cssText = `
                        text-align: center; 
                        padding: 40px; 
                        font-size: 1.2em; 
                        color: rgba(255, 255, 255, 0.7);
                        width: 100%;
                    `;
                    this.gridContainer.appendChild(messageElement);
                }

                openHistory() {
                    const historyModal = document.createElement('div');
                    historyModal.style.position = 'fixed';
                    historyModal.style.top = '0';
                    historyModal.style.left = '0';
                    historyModal.style.width = '100vw';
                    historyModal.style.height = '100vh';
                    historyModal.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
                    historyModal.style.display = 'flex';
                    historyModal.style.justifyContent = 'center';
                    historyModal.style.alignItems = 'center';
                    historyModal.style.zIndex = '1000';
                    historyModal.style.overflowY = 'auto';
                    historyModal.style.padding = '20px';
                    historyModal.style.boxSizing = 'border-box';
                    historyModal.style.backdropFilter = 'blur(15px)';
                    historyModal.style.opacity = '0';
                    historyModal.style.transition = 'opacity 0.3s ease';
                    
                    historyModal.innerHTML = `
                        <div id="historyContent" style="
                            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                            color: white;
                            padding: 30px;
                            border-radius: 20px;
                            max-width: 650px;
                            width: 100%;
                            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
                            border: 1px solid rgba(255,255,255,0.1);
                            transform: scale(0.9);
                            transition: transform 0.3s ease;
                            max-height: 80vh;
                            overflow-y: auto;
                        ">
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 25px;
                                padding-bottom: 15px;
                                border-bottom: 2px solid rgba(255,255,255,0.1);
                            ">
                                <h2 style="
                                    margin: 0;
                                    font-size: 28px;
                                    font-weight: 600;
                                    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
                                    -webkit-background-clip: text;
                                    -webkit-text-fill-color: transparent;
                                    background-clip: text;
                                ">Search History</h2>
                                <button id="closeHistoryX" style="
                                    background: none;
                                    border: none;
                                    color: #999;
                                    font-size: 24px;
                                    cursor: pointer;
                                    padding: 5px;
                                    border-radius: 50%;
                                    transition: all 0.2s ease;
                                    width: 35px;
                                    height: 35px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.1)'; this.style.color='white';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#999';">×</button>
                            </div>
                            
                            <div id="historyListContainer" style="
                                max-height: 400px;
                                overflow-y: auto;
                                margin-bottom: 25px;
                                padding-right: 10px;
                            ">
                                <ul id="historyList" style="
                                    list-style-type: none;
                                    padding: 0;
                                    margin: 0;
                                "></ul>
                            </div>
                            
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                gap: 15px;
                            ">
                                <button id="clearHistory" style="
                                    padding: 12px 24px;
                                    background: linear-gradient(45deg, #ff6b6b, #ee5a24);
                                    color: white;
                                    border: none;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 107, 107, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255, 107, 107, 0.3)';">Clear History</button>
                                
                                <button id="closeHistory" style="
                                    padding: 12px 24px;
                                    background: linear-gradient(45deg, #667eea, #764ba2);
                                    color: white;
                                    border: none;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)';">Close</button>
                            </div>
                        </div>
                    `;
                    
                    this.historyModalOpen = true;
                    document.body.appendChild(historyModal);
                    
                    setTimeout(() => {
                        historyModal.style.opacity = '1';
                        document.getElementById('historyContent').style.transform = 'scale(1)';
                    }, 10);
                    
                    const historyList = document.getElementById('historyList');
                    
                    if (this.searchCache.size === 0) {
                        const emptyState = document.createElement('div');
                        emptyState.style.textAlign = 'center';
                        emptyState.style.padding = '40px 20px';
                        emptyState.style.color = '#666';
                        emptyState.innerHTML = `
                            <div style="font-size: 48px; margin-bottom: 15px;">🔍</div>
                            <p style="font-size: 18px; margin: 0;">No search history yet</p>
                            <p style="font-size: 14px; margin: 5px 0 0 0; opacity: 0.7;">Your searches will appear here</p>
                        `;
                        historyList.appendChild(emptyState);
                    } else {
                        this.searchCache.forEach((images, term) => {
                            console.log("Adding history item:", term, images.length);
                            const listItem = document.createElement('li');
                            listItem.innerHTML = `
                                <div style="
                                    background: rgba(255, 255, 255, 0.05);
                                    margin-bottom: 12px;
                                    padding: 18px;
                                    border-radius: 12px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    border: 1px solid rgba(255, 255, 255, 0.1);
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                " onmouseover="
                                    this.style.background='rgba(255, 255, 255, 0.1)';
                                    this.style.transform='translateY(-2px)';
                                    this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.3)';
                                " onmouseout="
                                    this.style.background='rgba(255, 255, 255, 0.05)';
                                    this.style.transform='translateY(0)';
                                    this.style.boxShadow='none';
                                "
                                class="hover-target">
                                    <div>
                                        <div style="
                                            font-size: 16px;
                                            font-weight: 500;
                                            margin-bottom: 4px;
                                            color: #ffffff;
                                        ">${term}</div>
                                        <div style="
                                            font-size: 13px;
                                            color: #999;
                                            display: flex;
                                            align-items: center;
                                            gap: 8px;
                                        ">
                                            <span style="
                                                background: rgba(102, 126, 234, 0.2);
                                                padding: 2px 8px;
                                                border-radius: 10px;
                                                font-size: 11px;
                                                color: #667eea;
                                            ">${images.length} images</span>
                                        </div>
                                    </div>
                                    <div style="
                                        color: #667eea;
                                        font-size: 18px;
                                        opacity: 0.7;
                                        transition: opacity 0.2s ease;
                                    ">→</div>
                                </div>
                            `;
                            
                            listItem.addEventListener('click', () => {
                                this.backendImages = images;
                                console.log("Setting current theme:", term);
                                this.currentTheme = term;
                                document.getElementById('currentTheme').textContent = term;
                                this.spawnImages();
                                
                                historyModal.style.opacity = '0';
                                document.getElementById('historyContent').style.transform = 'scale(0.9)';
                                
                                setTimeout(() => {
                                    historyModal.remove();
                                    this.historyModalOpen = false;
                                }, 300);
                            });
                            
                            historyList.appendChild(listItem);
                        });
                    }
                    
                    const closeButton = document.getElementById('closeHistory');
                    const closeButtonX = document.getElementById('closeHistoryX');
                    
                    const closeModal = () => {
                        historyModal.style.opacity = '0';
                        document.getElementById('historyContent').style.transform = 'scale(0.9)';
                        setTimeout(() => {
                            historyModal.remove();
                            this.historyModalOpen = false;
                        }, 300);
                    };
                    
                    closeButton.addEventListener('click', closeModal);
                    closeButtonX.addEventListener('click', closeModal);
                    
                    const clearButton = document.getElementById('clearHistory');
                    clearButton.addEventListener('click', () => {
                        if (confirm('Are you sure you want to clear your search history?')) {
                            this.searchCache.clear();
                            closeModal();
                        }
                    });
                    
                    historyModal.addEventListener('click', (e) => {
                        if (e.target === historyModal) {
                            closeModal();
                        }
                    });
                    
                    const handleEscape = (e) => {
                        if (e.key === 'Escape') {
                            closeModal();
                            document.removeEventListener('keydown', handleEscape);
                        }
                    };
                    document.addEventListener('keydown', handleEscape);
                }
            
                openSettings() {
                    const settingsModal = document.createElement('div');
                    settingsModal.style.position = 'fixed';
                    settingsModal.style.top = '0';
                    settingsModal.style.left = '0';
                    settingsModal.style.width = '100vw';
                    settingsModal.style.height = '100vh';
                    settingsModal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                    settingsModal.style.display = 'flex';
                    settingsModal.style.justifyContent = 'center';
                    settingsModal.style.alignItems = 'center';
                    settingsModal.style.zIndex = '1000';
                    settingsModal.style.overflowY = 'auto';
                    settingsModal.style.padding = '20px';
                    settingsModal.style.boxSizing = 'border-box';
                    settingsModal.style.backdropFilter = 'blur(10px)';
                
                    const formatKeyDisplay = (key) => {
                        const keyMap = {
                            'ArrowUp': '↑',
                            'ArrowDown': '↓',
                            'ArrowLeft': '←',
                            'ArrowRight': '→',
                            'Enter': '⏎',
                            'Escape': 'Esc',
                            'Space': '⎵',
                            'Tab': '⇥',
                            'Shift': '⇧',
                            'Control': 'Ctrl',
                            'Alt': 'Alt',
                            'Meta': 'Cmd'
                        };
                        return keyMap[key] || key.toUpperCase();
                    };
                
                    const imageGrid = document.getElementById('imageGrid');
                    const firstGridItem = document.querySelector('.grid-item');
                    
                    const currentGap = imageGrid ? getComputedStyle(imageGrid).gap : '20px';
                    const currentBorderRadius = firstGridItem ? getComputedStyle(firstGridItem).borderRadius : '10px';
                    
                    settingsModal.innerHTML = `
                        <div style="background: #222; color: white; padding: 30px; border-radius: 16px; max-width: 500px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                            <h2 style="margin-top: 0; margin-bottom: 25px; font-size: 24px; text-align: center; color: #fff;">Settings</h2>
                            
                            <div style="margin-bottom: 30px;">
                                <label for="toggle2D" style="display: flex; align-items: center; margin-bottom: 15px; cursor: pointer; font-size: 16px;">
                                    <input type="checkbox" id="toggle2D" ${this.twodmode ? 'checked' : ''} style="margin-right: 10px; transform: scale(1.2);">
                                    Enable 2D Mode
                                </label>
                                <div style="margin-bottom: 15px;">
                                    <label for="backendInput">
                                        Backend URL:
                                    </label>
                                    <input type="text" id="backendInput" value="${this.backend}" 
                                           style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 4px; background: #333; color: #fff; font-size: 14px;">
                                    </input>
                                    <button id="updateBackendButton" style="
                                        margin-top: 10px; 
                                        padding: 8px 16px; 
                                        background: #4a90e2; 
                                        color: white; 
                                        border: none; 
                                        border-radius: 4px; 
                                        cursor: pointer; 
                                        font-size: 14px;
                                    " onmouseover="this.style.background='#357abd'" onmouseout="this.style.background='#4a90e2'">
                                        Update Backend
                                    </button>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <label for="speedSlider" style="display: block; margin-bottom: 8px; font-size: 16px;">3D Speed: <span id="speedValue">${this.speed}</span></label>
                                    <input type="range" id="speedSlider" min="0.3" max="3.0" step="0.1" value="${this.speed}" 
                                           style="width: 100%; height: 6px; background: #444; border-radius: 3px; outline: none; -webkit-appearance: none;">
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <label for="gapSlider" style="display: block; margin-bottom: 8px; font-size: 16px;">2D Gap: <span id="gapValue">${currentGap}</span></label>
                                    <input type="range" id="gapSlider" min="0" max="100" step="1" value="${parseInt(currentGap)}" 
                                           style="width: 100%; height: 6px; background: #444; border-radius: 3px; outline: none; -webkit-appearance: none;">
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <label for="borderRadiusSlider" style="display: block; margin-bottom: 8px; font-size: 16px;">2D Border Radius: <span id="borderRadiusValue">${currentBorderRadius}</span></label>
                                    <input type="range" id="borderRadiusSlider" min="0" max="50" step="1" value="${parseInt(currentBorderRadius)}" 
                                           style="width: 100%; height: 6px; background: #444; border-radius: 3px; outline: none; -webkit-appearance: none;">
                                </div>
                            </div>
                
                            <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; border-bottom: 2px solid #444; padding-bottom: 8px;">
                                ⌨️ Keybinds
                            </h3>
                            
                            <div id="keybindsContainer" style="margin-bottom: 30px; display: grid; gap: 12px;">
                                ${Object.entries(this.keybinds).map(([action, key]) => `
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                                        <span style="font-size: 14px; color: #ccc; flex: 1;">${this.keybindsName[action]}</span>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <div style="
                                                background: linear-gradient(145deg, #333, #222);
                                                border: 2px solid #444;
                                                border-radius: 6px;
                                                padding: 6px 12px;
                                                font-family: 'Courier New', monospace;
                                                font-size: 12px;
                                                font-weight: bold;
                                                color: #fff;
                                                text-shadow: 0 1px 2px rgba(0,0,0,0.5);
                                                box-shadow: 0 2px 4px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
                                                min-width: 40px;
                                                text-align: center;
                                            ">${formatKeyDisplay(key)}</div>
                                            <button 
                                                class="keybind-btn" 
                                                data-action="${action}" 
                                                style="
                                                    background: #4a90e2;
                                                    color: white;
                                                    border: none;
                                                    border-radius: 4px;
                                                    padding: 6px 10px;
                                                    cursor: pointer;
                                                    font-size: 12px;
                                                    transition: all 0.2s;
                                                "
                                                onmouseover="this.style.background='#357abd'"
                                                onmouseout="this.style.background='#4a90e2'"
                                            >Change</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button id="resetKeybinds" style="
                                    padding: 12px 20px;
                                    background: #666;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    transition: all 0.2s;
                                " onmouseover="this.style.background='#777'" onmouseout="this.style.background='#666'">
                                    Reset to Default
                                </button>
                                <button id="closeSettings" style="
                                    padding: 12px 20px;
                                    background: #ff4d4d;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    transition: all 0.2s;
                                " onmouseover="this.style.background='#ff3333'" onmouseout="this.style.background='#ff4d4d'">
                                    Close
                                </button>
                            </div>
                        </div>
                    `;
                
                    this.settingsModalOpen = true;
                    document.body.appendChild(settingsModal);
                
                    document.getElementById('updateBackendButton').addEventListener('click', () => {
                        const newBackend = document.getElementById('backendInput').value.trim();
                        if (newBackend) {
                            window.browser.backend = newBackend;
                            alert(`Backend URL updated to: ${newBackend}`);
                        } else {
                            alert('Please enter a valid backend URL.');
                        }
                    });
    
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && this.settingsModalOpen) {
                            settingsModal.remove();
                            this.settingsModalOpen = false;
                        }
                    });
                
                    const gapSlider = document.getElementById('gapSlider');
                    if (gapSlider) {
                        gapSlider.addEventListener('input', (e) => {
                            const gapValue = e.target.value + 'px';
                            if (imageGrid) {
                                imageGrid.style.gap = gapValue;
                            }
                            const gapValueElement = document.getElementById('gapValue');
                            if (gapValueElement) {
                                gapValueElement.textContent = gapValue;
                            }
                        });
                    }
                
                    const borderRadiusSlider = document.getElementById('borderRadiusSlider');
                    if (borderRadiusSlider) {
                        borderRadiusSlider.addEventListener('input', (e) => {
                            const borderRadiusValue = e.target.value + 'px';
                            const gridItems = document.querySelectorAll('.grid-item');
                            gridItems.forEach(gridItem => {
                                gridItem.style.borderRadius = borderRadiusValue;
                            });
                            const borderRadiusValueElement = document.getElementById('borderRadiusValue');
                            if (borderRadiusValueElement) {
                                borderRadiusValueElement.textContent = borderRadiusValue;
                            }
                        });
                    }
                
                    const speedSlider = document.getElementById('speedSlider');
                    const speedValue = document.getElementById('speedValue');
                    if (speedSlider && speedValue) {
                        speedSlider.addEventListener('input', (e) => {
                            this.speed = parseFloat(e.target.value);
                            speedValue.textContent = this.speed;
                        });
                    }
                
                    const keybindButtons = document.querySelectorAll('.keybind-btn');
                    keybindButtons.forEach(button => {
                        button.addEventListener('click', (e) => {
                            const action = e.target.dataset.action;
                            const keyDisplay = e.target.parentElement.querySelector('div');
                
                            e.target.textContent = 'Press key...';
                            e.target.disabled = true;
                            e.target.style.background = '#orange';
                
                            const keyListener = (keyEvent) => {
                                keyEvent.preventDefault();
                                keyEvent.stopPropagation();
                
                                const newKey = keyEvent.key;
                                this.keybinds[action] = newKey;
                                keyDisplay.textContent = formatKeyDisplay(newKey);
                                
                                e.target.textContent = 'Change';
                                e.target.disabled = false;
                                e.target.style.background = '#4a90e2';
                
                                document.removeEventListener('keydown', keyListener, true);
                                
                                console.log(`Keybind for "${action}" updated to: ${newKey}`);
                            };
                
                            document.addEventListener('keydown', keyListener, true);
                        });
                    });
                
                    const resetButton = document.getElementById('resetKeybinds');
                    if (resetButton) {
                        resetButton.addEventListener('click', () => {
                            const defaultKeybinds = {
                                toggle2D: 't',
                                sendToCanvas: 'c',
                                openHistory: 'h',
                                openSettings: 's',
                                increaseSpeed: 'ArrowUp',
                                decreaseSpeed: 'ArrowDown'
                            };
                
                            this.keybinds = { ...defaultKeybinds };
                
                            Object.entries(this.keybinds).forEach(([action, key]) => {
                                const keyDisplay = document.querySelector(`[data-action="${action}"]`).parentElement.querySelector('div');
                                if (keyDisplay) {
                                    keyDisplay.textContent = formatKeyDisplay(key);
                                }
                            });
                
                            console.log('Keybinds reset to default');
                        });
                    }
                
                    const closeButton = document.getElementById('closeSettings');
                    if (closeButton) {
                        closeButton.addEventListener('click', () => {
                            settingsModal.remove();
                            this.settingsModalOpen = false;
                        });
                    }
                    
                    if (typeof updateHoverTargets === 'function') {
                        updateHoverTargets();
                    }
                }
    
                createImageMesh(imageData) {
                    const aspectRatio = 4/5;
                    const width = 4;
                    const height = width / aspectRatio;
                    
                    const imageGeometry = new THREE.PlaneGeometry(width, height);
                    
                    if (this.imageCache.has(imageData.imageUrl)) {
                        const cachedTexture = this.imageCache.get(imageData.imageUrl);
                        const imageMaterial = new THREE.MeshBasicMaterial({ 
                            map: cachedTexture,
                            transparent: true,
                            opacity: 1.0
                        });
                        
                        const image = new THREE.Mesh(imageGeometry, imageMaterial);

                        return image;
                    }
                    
                    const loader = new THREE.TextureLoader();
                    const imageMaterial = new THREE.MeshBasicMaterial({ 
                        transparent: true,
                        opacity: 0,
                        color: new THREE.Color(0x000000)
                    });
                    
                    const image = new THREE.Mesh(imageGeometry, imageMaterial);
                    
                    loader.load(
                        imageData.imageUrl,
                        (texture) => {
                            const maxAnisotropy = this.renderer.capabilities.getMaxAnisotropy();
                            texture.anisotropy = maxAnisotropy;
                            texture.needsUpdate = true;
                            
                            this.imageCache.set(imageData.imageUrl, texture);
                            
                            imageMaterial.map = texture;
                            imageMaterial.color.setHex(0xffffff);
                            imageMaterial.needsUpdate = true;
                            
                            const fadeIn = () => {
                                if (imageMaterial.opacity < 1.0) {
                                    imageMaterial.opacity = Math.min(1.0, imageMaterial.opacity + 0.05);
                                    requestAnimationFrame(fadeIn);
                                }
                            };
                            fadeIn();
                        },
                        undefined,
                        (error) => {
                            console.warn('Failed to load texture:', imageData.imageUrl, error);
                            imageMaterial.opacity = 0.3;
                        }
                    );
                    
                    return image;
                }
    
                spawnSingleImage() {
                    if (!this.gameStarted || this.twodmode || this.backendImages.length === 0) return;

                    const imageUrl = this.backendImages[this.imageIndex % this.backendImages.length];

                    const imageData = {
                        id: `backend_${Date.now()}_${this.imageIndex}`,
                        theme: this.currentTheme,
                        name: `${this.currentTheme} #${this.imageIndex + 1}`,
                        imageUrl: imageUrl
                    };

                    this.imageIndex++;
                    
                    const image = this.createImageMesh(imageData);
                    
                    const maxSpawnRadius = 40;
                    const x = (Math.random() - 0.5) * maxSpawnRadius * 2;
                    const y = (Math.random() - 0.5) * maxSpawnRadius * 2;
                    const z = -60 - Math.random() * 60;
                    
                    image.position.set(x, y, z);
                    image.rotation.y = 0;
    
                    const baseSpeed = 0.025 + Math.random() * 0.02;
                    const velocity = new THREE.Vector3(
                        0,
                        0,
                        baseSpeed
                    );
                    
                    image.userData = {
                        imageData: imageData,
                        velocity: velocity,
                        selected: false,
                        rotationSpeed: 0
                    };
                    
                    this.scene.add(image);
                    this.images.push(image);
                    this.imagesSeen++;
                    updateHoverTargets();
                }

                spawnImages() {
                    if (!this.gameStarted || this.twodmode || this.backendImages.length === 0) return;

                    this.spawnSingleImage();
                    
                    const nextSpawnDelay = (this.spawnDelay / this.speed) + Math.random() * 200;
                    setTimeout(() => this.spawnImages(), nextSpawnDelay);
                }

    
                onMouseClick(event) {
                    if (this.twodmode || !this.gameStarted || this.isVR || this.historyModalOpen || this.settingsModalOpen) return;
    
                    this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                    this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
    
                    this.raycaster.setFromCamera(this.mouse, this.camera);
                    const intersects = this.raycaster.intersectObjects(this.images);
    
                    if (intersects.length > 0) {
                        const clickedImage = intersects[0].object;
                        this.selectImage(clickedImage);
                    }
                }
    
                onMouseMove(event) {
                    if (this.twodmode || !this.gameStarted || this.isVR) return;
    
                    this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                    this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
    
                    this.raycaster.setFromCamera(this.mouse, this.camera);
                    const intersects = this.raycaster.intersectObjects(this.images);
    
                    this.images.forEach(image => {
                        if (!image.userData.selected) {
                            image.scale.set(1, 1, 1);
                            image.material.opacity = 0.9;
                        }
                    });
    
                    if (intersects.length > 0) {
                        const hoveredImage = intersects[0].object;
                        cursor.classList.add('hover');
                        if (!hoveredImage.userData.selected) {
                            hoveredImage.scale.set(1.15, 1.15, 1.15);
                            hoveredImage.material.opacity = 1.0;
                        }
                    }
                }

                onMouseWheel(event) {
                    if (!this.gameStarted || this.twodmode) {
                        return;
                    }

                    if (event.target.closest('#ui, #selectedImages, #controls, #gridContainer')) {
                        return;
                    }

                    event.preventDefault();

                    this.scrollAccumulator += Math.abs(event.deltaY);

                    while (this.scrollAccumulator >= this.scrollSpawnThreshold) {
                        this.spawnSingleImage();
                        this.scrollAccumulator -= this.scrollSpawnThreshold;
                    }
                }
    
                onControllerSelect(event, controllerIndex) {
                    if (!this.gameStarted) return;
    
                    const controller = this.controllers[controllerIndex];
                    const tempMatrix = new THREE.Matrix4();
                    tempMatrix.identity().extractRotation(controller.matrixWorld);
    
                    const raycaster = new THREE.Raycaster();
                    raycaster.ray.origin.setFromMatrixPosition(controller.matrixWorld);
                    raycaster.ray.direction.set(0, 0, -1).applyMatrix4(tempMatrix);
    
                    const intersects = raycaster.intersectObjects(this.images);
    
                    if (intersects.length > 0) {
                        const image = intersects[0].object;
                        this.selectImage(image);
                    }
                }
    
                selectImage(image, gridItem = null) {
                    let imageData;

                    if (gridItem) { 
                        const dataString = gridItem.dataset.imageData;
                        if (!dataString) return;
                        imageData = JSON.parse(dataString);
                    } else if (image) {
                        if (image.userData.selected) return;
                        image.userData.selected = true;
                        imageData = image.userData.imageData;
                    } else {
                        return;
                    }

                    const newItemForBoard = {
                        ...imageData,
                        id: `item-${Date.now()}-${Math.random()}`
                    };

                    this.selectedImages.push(newItemForBoard);
                    localStorage.setItem('vrInspirationBoard', JSON.stringify(this.selectedImages));
                    
                    if (image) { 
                        this.scene.remove(image);
                        const index = this.images.indexOf(image);
                        if (index > -1) this.images.splice(index, 1);
                    }

                    this.updateSelectedImagesUI();
                    this.updateUI();
                }

                deleteImage(image) {
                    const index = this.selectedImages.findIndex(img => img.id === image);
                    if (index > -1) {
                        this.selectedImages.splice(index, 1);
                        localStorage.setItem('vrInspirationBoard', JSON.stringify(this.selectedImages));
                        console.log("Local storage after deletion: ", localStorage.getItem('vrInspirationBoard'));
                        this.updateSelectedImagesUI();
                    }
                }

                updateSelectedImagesUI() {
                    const selectedList = document.getElementById('selectedList');
                    selectedList.innerHTML = '';

                    this.selectedImages.slice(-5).forEach((imageData, index) => {
                        const imageElement = document.createElement('div');
                        imageElement.className = 'selected-image';
                        imageElement.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                        <img src="${imageData.imageUrl}" alt="${imageData.name}" class="hover-target" style="transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);"
                        onmouseenter="this.style.transform='translateY(-3px) scale(1.05)';"
                        onmouseleave="this.style.transform='translateY(0) scale(1)';">
                        <button style="padding: 5px; margin-left: 10px;" onclick="console.log('Deleting image:', '${imageData.id}'); window.browser.deleteImage('${imageData.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash2-icon lucide-trash-2"><path d="M10 11v6"/><path d="M14 11v6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                        <button style="padding: 5px; margin-left: 10px;" onclick="fetch('${imageData.imageUrl}')
                            .then(response => response.blob())
                                .then(blob => {
                                    console.log('Searching image:', blob);
                                    window.browser.searchImage(blob).catch(error => {
                                        console.error('Error searching image:', error);
                                    });
                                })
                                .catch(error => {
                                    console.error('Error fetching image blob:', error);
                            });">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right-to-line-icon lucide-arrow-right-to-line">
                                <path d="M17 12H3"/>
                                <path d="m11 18 6-6-6-6"/>
                                <path d="M21 5v14"/>
                            </svg>
                        </button>
                        </div>`;  
                        imageElement.addEventListener('mouseenter', () => cursor.classList.add('hover'));
                        imageElement.addEventListener('mouseleave', () => cursor.classList.remove('hover'));
                        imageElement.querySelector('img').addEventListener('click', () => {
                            const modal = document.createElement('div');
                            modal.style.position = 'fixed';
                            modal.style.top = '0';
                            modal.style.left = '0';
                            modal.style.width = '100vw';
                            modal.style.height = '100vh';
                            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                            modal.style.display = 'flex';
                            modal.style.justifyContent = 'center';
                            modal.style.alignItems = 'center';
                            modal.style.zIndex = '1000';
        
                            const modalContent = document.createElement('div');
                            modalContent.style.position = 'relative';
                            modalContent.style.maxWidth = '90%';
                            modalContent.style.maxHeight = '90%';
                            modalContent.style.backgroundColor = '#000';
                            modalContent.style.borderRadius = '12px';
                            modalContent.style.overflow = 'hidden';
                            modalContent.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.5)';
        
                            const modalImage = document.createElement('img');
                            modalImage.src = imageData.imageUrl;
                            modalImage.alt = imageData.name;
                            modalImage.style.width = '100%';
                            modalImage.style.height = '100%';
                            modalImage.style.objectFit = 'contain';
        
                            const closeButton = document.createElement('button');
                            closeButton.textContent = 'Close';
                            closeButton.style.position = 'absolute';
                            closeButton.style.top = '10px';
                            closeButton.style.right = '10px';
                            closeButton.style.padding = '10px 20px';
                            closeButton.style.backgroundColor = '#ff4d4d';
                            closeButton.style.color = '#fff';
                            closeButton.style.border = 'none';
                            closeButton.style.borderRadius = '6px';
                            closeButton.style.cursor = 'pointer';
                            closeButton.style.fontSize = '16px';
        
                            closeButton.addEventListener('click', () => {
                                modal.remove();
                            });
        
                            closeButton.addEventListener('mouseenter', () => {
                                console.log("Setting cursor to hover");
                                cursor.classList.add('hover')});
                            closeButton.addEventListener('mouseleave', () => cursor.classList.remove('hover'));

                            modalContent.appendChild(modalImage);
                            modalContent.appendChild(closeButton);
                            modal.appendChild(modalContent);
                            document.body.appendChild(modal);
                        });
                        selectedList.appendChild(imageElement);
                    });
                }
    
                onWindowResize() {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                }
                clearScene() {
                    for (let i = this.images.length - 1; i >= 0; i--) {
                        this.scene.remove(this.images[i]);
                    }
                    this.images = [];
                }
    
                updateImages() {
                    for (let i = this.images.length - 1; i >= 0; i--) {
                        const image = this.images[i];
                        
                        if (!image.userData.selected) {
                            const velocity = image.userData.velocity.clone().multiplyScalar(this.speed);
                            image.position.add(velocity);
                                                        
                            if (image.position.z > 10) {
                                this.scene.remove(image);
                                this.images.splice(i, 1);
                            }
                        }
                    }
                }
    
                updateUI() {
                    document.getElementById('imageCount').textContent = this.imagesSeen;
                    document.getElementById('selectedCount').textContent = this.selectedImages.length;
                    document.getElementById('speedDisplay').textContent = this.speed.toFixed(1) + 'x';
                }
    
                animate() {
                    this.renderer.setAnimationLoop(() => {
                        if (this.gameStarted && !this.twodmode) {
                            this.updateImages();
                        }
                        this.updateUI();
                        this.renderer.render(this.scene, this.camera);
                    });
                }
            }
    
            window.addEventListener('load', () => {
                const browser = new VRInspirationBrowser();
                window.browser = browser;
                document.getElementById('searchForm').addEventListener('submit', function(event) {
                    event.preventDefault();
                    
                    const searchValue = document.getElementById('searchInput').value;
                    console.log('Search submitted:', searchValue);
                    browser.lastSearch = { type: 'text', query: searchValue };                
                    browser.searchText(searchValue).then(() => {
                        browser.startGame();
                    }).catch(error => {
                        console.error('Error during search:', error);
                    });
                });

                document.getElementById('searchBar').addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        const searchValue = this.value;
                        console.log('Search submitted:', searchValue);
                        browser.lastSearch = { type: 'text', query: searchValue };
                        browser.searchText(searchValue).then(() => {
                            browser.startGame();
                        }).catch(error => {
                            console.error('Error during search:', error);
                        });
                    }
                });

                document.querySelector('#ui button[type="submit"]').addEventListener('click', function(event) {
                    event.preventDefault();
                    const searchValue = document.getElementById('searchBar').value;
                    console.log('Search submitted:', searchValue);
                    browser.lastSearch = { type: 'text', query: searchValue };
                    browser.searchText(searchValue).then(() => {
                        browser.startGame();
                    }).catch(error => {
                        console.error('Error during search:', error);
                    });
                });

                document.addEventListener('mousemove', (e) => {
                    const elementUnderMouse = document.elementFromPoint(e.clientX, e.clientY);
                    const isOverHoverElement = elementUnderMouse && (
                        elementUnderMouse.matches('a, button, input, select, .hover-target, .selected-image') ||
                        elementUnderMouse.closest('a, button, input, select, .hover-target, .selected-image')
                    );
                    
                    if (!isOverHoverElement) {
                        const mouse = new THREE.Vector2();
                        mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
                        mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                        
                        if (browser && browser.raycaster && browser.images) {
                            browser.raycaster.setFromCamera(mouse, browser.camera);
                            const intersects = browser.raycaster.intersectObjects(browser.images);
                            if (intersects.length === 0) {
                                cursor.classList.remove('hover');
                            }
                        }
                    }
                });
            });
        </script>
    </body>
</html>